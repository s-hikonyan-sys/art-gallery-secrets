# Art Gallery Secrets API

パスワード復号化専用のマイクロサービスです。システムの起動時に暗号化された機密情報を復号し、安全なワンタイムトークンを用いて他のコンテナ（backend, database）にパスワードを配布します。

## 概要

このサービスは、以下のセキュリティ上の課題を解決するために導入されました：
- 複数のコンテナに暗号化キーを配布するリスクの低減
- 復号ロジックの一元化
- パスワード配布後の機密情報へのアクセス経路の遮断

## 主な機能

- **機密情報の復号**: `Fernet`（対称暗号）を使用して、Ansible Vault等で暗号化された設定ファイルを復号します。
- **ワンタイムトークン配布**: 起動時に各サービス専用のランダムトークンを生成し、ファイルとして共有します。
- **セキュリティ認証**: `Authorization: Bearer <token>` ヘッダーによる厳格なトークン検証。
- **自動ライフサイクル管理**: 
    - **ワンタイム利用**: トークンは使用された瞬間に削除され、再利用は不可能です。
    - **自動シャットダウン**: すべてのトークンが消費された、あるいは起動から5分経過（タイムアウト）すると、プロセス自体が自動的に終了します。

## アーキテクチャ

1.  **起動**: `secrets-api` が最初に起動し、復号キーを使ってパスワードを準備、2つのトークンを生成します。
2.  **配布**: 他のコンテナが起動し、マウントされたボリュームからトークンを読み取ります。
3.  **提供**: 他のコンテナがトークンを提示してAPIにリクエストし、`secrets-api` がパスワードを返却します。
4.  **消滅**: `secrets-api` はトークンファイルを削除し、役割を終えると自ら終了します。

## 技術スタック

- **Framework**: Flask
- **Security**: Cryptography (Fernet)
- **Testing**: pytest, pytest-cov
- **Linting**: flake8, pylint, mypy, black, isort

## セットアップと実行

### 依存関係のインストール

```bash
pip install -r requirements-dev.txt
```

### テストの実行

```bash
bash tests/run_tests.sh
```

## API エンドポイント

### GET /secrets/database/password
データベースのパスワードを取得します。

- **Header**: `Authorization: Bearer <token>`
- **Response**: `{"password": "..."}`

### GET /health
サービスの稼働状態を確認します（認証不要）。

## セキュリティ設計のポイント（ポートフォリオ用）

- **最小権限**: 各サービスごとに個別のトークンを発行し、必要な情報のみを返却。
- **攻撃表面の最小化**: 役割を終えた瞬間にプロセスを終了させることで、稼働時間を最小限に抑制。
- **ネットワーク分離**: Docker内部ネットワークのみで通信し、ホストや外部からはアクセス不可。
